<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BizenDAO - ã‚¦ã‚©ãƒ¬ãƒƒãƒˆè§£é™¤</title>
    <link rel="stylesheet" href="css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js" crossorigin="anonymous"></script>
    <script src="js/config.js"></script>
    <script src="js/cache.js"></script>
    <script src="js/nft.js"></script>
    <script src="js/wallet.js"></script>

    <style>
      main {
        padding-top: 100px;
        min-height: 100vh;
      }

      .disconnect-page {
        max-width: 640px;
        margin: 0 auto;
        padding: 5px 20px 60px;
      }

      .page-title {
        font-size: 28px;
        margin-bottom: 32px;
        font-family: "Times New Roman", "Hiragino Mincho ProN", serif;
      }

      .btn {
        padding: 12px 24px;
        border: 1px solid rgba(255,255,255,0.3);
        background: transparent;
        color: #f6f6f6;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn:hover { background: rgba(255,255,255,0.1); }
      .btn:disabled { opacity: 0.4; cursor: not-allowed; }

      .btn-connect {
        display: block;
        width: 100%;
        padding: 16px;
        font-size: 16px;
        background: rgba(255,255,255,0.06);
        margin-bottom: 24px;
      }

      .btn-danger {
        border-color: rgba(255,80,80,0.5);
        color: #ff6666;
        padding: 14px 32px;
        font-size: 15px;
      }

      .btn-danger:hover:not(:disabled) {
        background: rgba(255,80,80,0.12);
      }

      .section-card {
        background: rgba(255,255,255,0.04);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 10px;
        padding: 24px;
        margin-bottom: 24px;
      }

      .section-card h2 {
        font-size: 18px;
        margin-bottom: 14px;
      }

      .section-card p {
        line-height: 1.7;
        font-size: 14px;
        opacity: 0.85;
        margin-bottom: 12px;
      }

      .info-row {
        display: flex;
        gap: 8px;
        align-items: center;
        padding: 8px 0;
        font-size: 14px;
      }

      .info-label {
        opacity: 0.5;
        min-width: 100px;
      }

      .info-value {
        font-family: monospace;
        word-break: break-all;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        margin-bottom: 16px;
      }

      .status-badge.has-sbt {
        background: rgba(255,200,50,0.12);
        border: 1px solid rgba(255,200,50,0.3);
        color: #ffcc44;
      }

      .status-badge.no-sbt {
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.15);
        color: rgba(255,255,255,0.5);
      }

      .status-badge.discord {
        background: rgba(88,101,242,0.15);
        border: 1px solid rgba(88,101,242,0.3);
        color: #7289da;
      }

      .warning-text {
        color: #ff9966;
        font-size: 13px;
        line-height: 1.6;
      }

      .success-card {
        padding: 24px;
        background: rgba(0,255,100,0.08);
        border: 1px solid rgba(0,255,100,0.25);
        border-radius: 10px;
        text-align: center;
        margin-bottom: 24px;
      }

      .success-card h3 { color: #66ff99; margin-bottom: 8px; }

      .error-message {
        padding: 12px 16px;
        background: rgba(255,0,0,0.1);
        border: 1px solid rgba(255,0,0,0.3);
        border-radius: 6px;
        color: #ff6666;
        font-size: 13px;
        margin-bottom: 16px;
      }

      .connect-prompt {
        text-align: center;
        padding: 60px 20px;
      }

      .loading-spinner {
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 2px solid rgba(255,255,255,0.2);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin { to { transform: rotate(360deg); } }

      .loading-center { text-align: center; padding: 30px; }

      .link { color: #6bb6ff; text-decoration: none; }
      .link:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <div id="app">
      <header class="site-header">
        <div class="container header-inner">
          <a href="index.html" class="logo"><img src="./img/349F5603-389E-48C6-81C9-1515A338A59B.png" alt="ãƒ­ã‚´"></a>
          <div class="header-right">
            <button class="lang-toggle" type="button">EN/JP</button>
            <button class="nav-toggle" type="button" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹é–‰" @click="toggleMenu">
              <span></span><span></span>
            </button>
          </div>
        </div>
        <div class="nav-overlay" :class="{ 'is-open': menuOpen }" @click="closeMenu"></div>
        <aside class="nav-drawer" :class="{ 'is-open': menuOpen }" aria-label="ã‚µã‚¤ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼">
          <ul class="drawer-nav">
            <li><a href="./index.html">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</a></li>
            <li><a href="./artist-list.html">ä½œå®¶ç´¹ä»‹</a></li>
            <li><a href="./donation.html">å¯„ä»˜</a></li>
            <li><a href="./account.html">ãƒã‚¤ãƒšãƒ¼ã‚¸</a></li>
          </ul>
        </aside>
      </header>

      <main>
        <div class="disconnect-page">
          <h1 class="page-title">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶šè§£é™¤</h1>

          <!-- æœªæ¥ç¶š -->
          <div v-if="!connected" class="connect-prompt">
            <p style="margin-bottom: 24px; opacity: 0.7;">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ¥ç¶šã—ã¦ãã ã•ã„</p>
            <button v-if="metamaskAvailable" class="btn btn-connect" @click="connectWallet" :disabled="connecting">
              {{ connecting ? 'æ¥ç¶šä¸­...' : 'ğŸ¦Š ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ¥ç¶š' }}
            </button>
            <p v-else style="opacity:0.5;">MetaMaskãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
          </div>

          <!-- æ¥ç¶šæ¸ˆã¿ -->
          <template v-else>
            <div v-if="loading" class="loading-center"><span class="loading-spinner"></span></div>

            <template v-else>
              <div v-if="error" class="error-message">{{ error }}</div>

              <!-- è§£é™¤å®Œäº† -->
              <div v-if="disconnected" class="success-card">
                <h3>âœ… æ¥ç¶šè§£é™¤ãŒå®Œäº†ã—ã¾ã—ãŸ</h3>
                <p style="opacity:0.7;">Discordé€£æºãŒè§£é™¤ã•ã‚Œã¾ã—ãŸã€‚</p>
                <a href="index.html" class="btn" style="margin-top:12px;">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
              </div>

              <template v-else>
                <!-- çŠ¶æ…‹è¡¨ç¤º -->
                <div class="section-card">
                  <h2>ç¾åœ¨ã®çŠ¶æ…‹</h2>
                  <div class="info-row">
                    <span class="info-label">EOA</span>
                    <span class="info-value">{{ address }}</span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">ãƒ¡ãƒ³ãƒãƒ¼SBT</span>
                    <span>
                      <span v-if="hasSbt" class="status-badge has-sbt">æ‰€æœ‰ã‚ã‚Š</span>
                      <span v-else class="status-badge no-sbt">ãªã—</span>
                    </span>
                  </div>
                  <div class="info-row">
                    <span class="info-label">Discord</span>
                    <span v-if="discordId">
                      <span class="status-badge discord">{{ discordId }}</span>
                    </span>
                    <span v-else style="opacity:0.5;">æœªé€£æº</span>
                  </div>
                </div>

                <!-- SBTãŒã‚ã‚‹å ´åˆï¼šBURNãŒå…ˆ -->
                <div v-if="hasSbt" class="section-card">
                  <h2>ğŸ“œ ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ã®BURN</h2>
                  <p>ã‚¦ã‚©ãƒ¬ãƒƒãƒˆè§£é™¤ã‚’è¡Œã†ãŸã‚ã«ã¯ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ï¼ˆSBTï¼‰ã®BURNãŒå¿…è¦ã§ã™ã€‚</p>
                  <p>
                    <a :href="'account.html?address=' + address" class="link">
                      ã“ã¡ã‚‰ã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ã®SBTã‚’é–‹ãã€BURNã‚’è¡Œãªã£ã¦ãã ã•ã„ â†’
                    </a>
                  </p>
                </div>

                <!-- SBTãŒãªã„å ´åˆï¼šDiscordè§£é™¤å¯èƒ½ -->
                <div v-else-if="discordId" class="section-card">
                  <h2>ğŸ”Œ Discordé€£æºè§£é™¤</h2>
                  <p>
                    DiscordID: <strong>{{ discordId }}</strong><br>
                    ã“ã¡ã‚‰ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶šã‚’è§£é™¤ã—ã¾ã™ã€‚
                  </p>
                  <p class="warning-text">
                    âš  ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚å†åº¦é€£æºã™ã‚‹ã«ã¯Discordã§ /regist ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
                  </p>
                  <button class="btn btn-danger" @click="executeDisconnect" :disabled="sending" style="margin-top: 12px;">
                    <span v-if="sending"><span class="loading-spinner" style="width:16px;height:16px;border-width:2px;"></span> å‡¦ç†ä¸­...</span>
                    <span v-else>DISCONNECT</span>
                  </button>
                </div>

                <!-- Discordæœªé€£æº & SBTãªã— -->
                <div v-else class="section-card">
                  <h2>ç™»éŒ²å¯èƒ½</h2>
                  <p>{{ address }} ã¯ç™»éŒ²å¯èƒ½ã§ã™ã€‚</p>
                  <p>Discordã«ã¦ <strong>/regist</strong> ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
                </div>
              </template>
            </template>
          </template>
        </div>
      </main>
    </div>

    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            menuOpen: false,
            connected: false,
            connecting: false,
            loading: false,
            sending: false,
            error: null,
            address: null,
            hasSbt: false,
            discordId: null,
            disconnected: false,
          };
        },
        computed: {
          metamaskAvailable() { return Wallet.isAvailable(); },
        },
        async mounted() {
          const r = await Wallet.reconnect();
          if (r) {
            this.address = r.address;
            this.connected = true;
            await Wallet.ensurePolygon();
            await this.checkStatus();
          }
        },
        methods: {
          async connectWallet() {
            this.connecting = true; this.error = null;
            try {
              const { address } = await Wallet.connect();
              await Wallet.ensurePolygon();
              this.address = address;
              this.connected = true;
              await this.checkStatus();
            } catch (e) { this.error = e.message; }
            this.connecting = false;
          },

          async checkStatus() {
            this.loading = true;
            try {
              // SBTç¢ºèª
              const sbtIds = await NFTHelper.getOwnedTokenIds(CONFIG.contracts.sbt.address, this.address);
              this.hasSbt = sbtIds.length > 0;

              // Discordé€£æºç¢ºèª
              try {
                const res = await fetch(CONFIG.botApi + 'member/' + this.address);
                const data = await res.json();
                this.discordId = data.DiscordId || null;
              } catch (e) {
                console.warn('Discord check failed:', e);
                this.discordId = null;
              }
            } catch (e) {
              this.error = 'çŠ¶æ…‹ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message;
            }
            this.loading = false;
          },

          async executeDisconnect() {
            if (!confirm('æœ¬å½“ã«æ¥ç¶šè§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            this.sending = true; this.error = null;
            try {
              const res = await fetch(CONFIG.botApi + 'disconnect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  eoa: this.address,
                  discordId: this.discordId,
                }),
              });
              const result = await res.json();
              console.log('disconnect result:', result);
              this.disconnected = true;
            } catch (e) {
              this.error = 'è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message;
            }
            this.sending = false;
          },

          toggleMenu() {
            this.menuOpen = !this.menuOpen;
            document.body.style.overflow = this.menuOpen ? 'hidden' : '';
          },
          closeMenu() {
            this.menuOpen = false;
            document.body.style.overflow = '';
          },
        },
      }).mount('#app');
    </script>
  </body>
</html>
