<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BizenDAO - Contract Token List</title>
    
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Web3.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js" crossorigin="anonymous"></script>
    
    <!-- Vue 3 CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js" crossorigin="anonymous"></script>

    <!-- BizenDAO ÂÖ±ÈÄö„É¢„Ç∏„É•„Éº„É´ -->
    <script src="js/config.js"></script>
    <script src="js/cache.js"></script>
    <script src="js/nft.js"></script>
    
    <style>
        main {
            padding-top: 100px;
            min-height: 100vh;
        }
        
        .contract-viewer {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .viewer-title {
            text-align: center;
            font-size: 36px;
            margin-bottom: 20px;
            font-family: "Times New Roman", "Hiragino Mincho ProN", serif;
            letter-spacing: 0.1em;
        }
        
        .viewer-subtitle {
            text-align: center;
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 40px;
        }
        
        /* „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´ */
        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 40px;
        }
        
        .input-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }
        
        .input-field label {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .input-field input {
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #f6f6f6;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
        }
        
        .input-field input:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.08);
        }
        
        .action-buttons {
            display: flex;
            gap: 16px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: transparent;
            color: #f6f6f6;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .btn-primary {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ‰ΩúÂÆ∂„Éó„É™„Çª„ÉÉ„Éà„Éú„Çø„É≥ */
        .artist-presets {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .artist-btn {
            padding: 8px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #f6f6f6;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .artist-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .artist-btn.active {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        /* „Çπ„ÉÜ„Éº„Çø„Çπ */
        .status-message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .status-info {
            background: rgba(0, 100, 255, 0.1);
            border: 1px solid rgba(0, 100, 255, 0.3);
            color: #6bb6ff;
        }
        
        .status-success {
            background: rgba(0, 255, 100, 0.1);
            border: 1px solid rgba(0, 255, 100, 0.3);
            color: #66ff99;
        }
        
        .status-error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
            color: #ff6666;
        }

        /* „Ç≥„É≥„Éà„É©„ÇØ„ÉàÊÉÖÂ†± */
        .contract-info {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 12px;
            opacity: 0.6;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .info-value {
            font-size: 16px;
            font-weight: 500;
        }

        /* „Ç´„Éº„Éâ„Ç∞„É™„ÉÉ„Éâ */
        .token-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .token-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .token-card:hover {
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .token-card-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background: rgba(0, 0, 0, 0.2);
        }

        .token-card-placeholder {
            width: 100%;
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.03);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            opacity: 0.3;
        }

        .token-card-info {
            padding: 14px;
        }

        .token-card-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .token-card-id {
            font-size: 12px;
            opacity: 0.5;
            font-family: monospace;
        }
        
        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .loading-content {
            text-align: center;
        }
        
        .loading-content .loading-spinner {
            width: 40px;
            height: 40px;
            margin-bottom: 20px;
        }
        
        /* „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ */
        .network-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(130, 71, 229, 0.1);
            border: 1px solid rgba(130, 71, 229, 0.3);
            border-radius: 20px;
            font-size: 14px;
            margin-top: 40px;
        }
        
        .network-dot {
            width: 8px;
            height: 8px;
            background: #66ff99;
            border-radius: 50%;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 768px) {
            .token-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header class="site-header">
            <div class="container header-inner">
                <a href="index.html" class="logo"><img src="./img/349F5603-389E-48C6-81C9-1515A338A59B.png" alt="„É≠„Ç¥"></a>
                <div class="header-right">
                    <button class="lang-toggle" type="button">EN/JP</button>
                    <button class="nav-toggle" type="button" aria-label="„É°„Éã„É•„Éº„ÇíÈñãÈñâ" @click="toggleMenu">
                        <span></span><span></span>
                    </button>
                </div>
            </div>
            <div class="nav-overlay" :class="{ 'is-open': menuOpen }" @click="closeMenu"></div>
            <aside class="nav-drawer" :class="{ 'is-open': menuOpen }" aria-label="„Çµ„Ç§„Éà„É°„Éã„É•„Éº">
                <ul class="drawer-nav">
                    <li><a href="./index.html">„Éà„ÉÉ„Éó„Éö„Éº„Ç∏</a></li>
                    <li><a href="./artist-list.html">‰ΩúÂÆ∂Á¥π‰ªã</a></li>
                    <li><a href="./index.html#company">‰ºöÁ§æÊ¶ÇË¶Å</a></li>
                    <li><a href="./index.html#discord">Discord„É™„É≥„ÇØ</a></li>
                    <li><a href="./index.html#meta">‰ΩúÂìÅ‰ΩøÁî®Ê≠¥‰ΩúÊàê</a></li>
                    <li><a href="./index.html#donate">ÂØÑ‰ªò„Éù„Ç§„É≥„Éà</a></li>
                    <li><a href="./index.html#myaccount">„Éû„Ç§„Éö„Éº„Ç∏</a></li>
                </ul>
            </aside>
        </header>

        <main>
            <div class="contract-viewer">
                <h1 class="viewer-title">Contract Token List</h1>
                <p class="viewer-subtitle">NFT„Ç≥„É≥„Éà„É©„ÇØ„Éà„ÅÆ„Éà„Éº„ÇØ„É≥‰∏ÄË¶ß</p>
                
                <!-- „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´ -->
                <div class="control-panel">
                    <!-- ‰ΩúÂÆ∂„Éó„É™„Çª„ÉÉ„Éà -->
                    <div style="margin-bottom: 20px;">
                        <label style="font-size: 14px; opacity: 0.8;">‰ΩúÂÆ∂„ÅßÈÅ∏„Å∂</label>
                        <div class="artist-presets">
                            <button v-for="artist in artists" :key="artist.key"
                                class="artist-btn" :class="{ active: contractAddress === artist.address }"
                                @click="selectArtist(artist)">
                                {{ artist.name }}
                            </button>
                        </div>
                    </div>

                    <div class="input-field">
                        <label>NFT„Ç≥„É≥„Éà„É©„ÇØ„Éà„Ç¢„Éâ„É¨„Çπ</label>
                        <input type="text" v-model="contractAddress" placeholder="0x..." @keyup.enter="loadContract" />
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" @click="loadContract" :disabled="loading || !contractAddress">
                            <span v-if="loading" class="loading-spinner"></span>
                            <span v-else>„Éà„Éº„ÇØ„É≥‰∏ÄË¶ß„ÇíÂèñÂæó</span>
                        </button>
                        <button class="btn" @click="clearData">„ÇØ„É™„Ç¢</button>
                    </div>
                    
                    <div v-if="statusMessage" :class="['status-message', statusClass]">
                        {{ statusMessage }}
                    </div>
                </div>
                
                <!-- „Ç≥„É≥„Éà„É©„ÇØ„ÉàÊÉÖÂ†± -->
                <div v-if="contractInfo.name" class="contract-info">
                    <div class="info-item">
                        <span class="info-label">ÂêçÂâç</span>
                        <span class="info-value">{{ contractInfo.name }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">„Ç∑„É≥„Éú„É´</span>
                        <span class="info-value">{{ contractInfo.symbol }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Á∑èÁô∫Ë°åÊï∞</span>
                        <span class="info-value">{{ contractInfo.totalSupply }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">„Ç≥„É≥„Éà„É©„ÇØ„Éà</span>
                        <span class="info-value" style="font-family: monospace; font-size: 13px;">
                            <a :href="CONFIG.chain.explorer + '/address/' + contractAddress" target="_blank" 
                               style="color: #6bb6ff; text-decoration: none;">
                                {{ contractAddress.slice(0, 10) }}...{{ contractAddress.slice(-6) }}
                            </a>
                        </span>
                    </div>
                </div>
                
                <!-- „Éà„Éº„ÇØ„É≥„Ç´„Éº„Éâ„Ç∞„É™„ÉÉ„Éâ -->
                <div v-if="tokenCards.length > 0" class="token-grid">
                    <a v-for="card in tokenCards" :key="card.tokenId"
                       :href="'token.html?ca=' + contractAddress + '&id=' + card.tokenId"
                       class="token-card">
                        <img v-if="card.image" :src="card.image" :alt="card.name"
                             class="token-card-image" @error="handleImageError($event)" />
                        <div v-else class="token-card-placeholder">üè∫</div>
                        <div class="token-card-info">
                            <div class="token-card-name">{{ card.name || 'Loading...' }}</div>
                            <div class="token-card-id">#{{ card.tokenId }}</div>
                        </div>
                    </a>
                </div>

                <!-- „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØË°®Á§∫ -->
                <div class="network-badge">
                    <span class="network-dot"></span>
                    <span>{{ CONFIG.chain.name }}</span>
                </div>
                
                <!-- „É≠„Éº„Éá„Ç£„É≥„Ç∞ -->
                <div v-if="loading" class="loading-overlay">
                    <div class="loading-content">
                        <div class="loading-spinner"></div>
                        <p>{{ loadingMessage }}</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    contractAddress: '',
                    contractInfo: {},
                    tokenCards: [],
                    loading: false,
                    loadingMessage: '„Éà„Éº„ÇØ„É≥‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø‰∏≠...',
                    statusMessage: '',
                    statusClass: '',
                    menuOpen: false,
                    artists: CONFIG.contracts.nfts,
                    CONFIG: CONFIG,
                };
            },
            mounted() {
                this.loadFromUrlParams();
                window.addEventListener('keydown', this.handleEscape);
            },
            methods: {
                loadFromUrlParams() {
                    const params = new URLSearchParams(window.location.search);
                    const ca = params.get('ca');
                    if (ca) {
                        this.contractAddress = ca;
                        this.loadContract();
                    }
                },

                selectArtist(artist) {
                    this.contractAddress = artist.address;
                    this.loadContract();
                },

                async loadContract() {
                    if (!this.contractAddress) return;

                    this.loading = true;
                    this.tokenCards = [];
                    this.contractInfo = {};
                    this.loadingMessage = '„Ç≥„É≥„Éà„É©„ÇØ„ÉàÊÉÖÂ†±„ÇíÂèñÂæó‰∏≠...';

                    try {
                        // „Ç≥„É≥„Éà„É©„ÇØ„ÉàÊÉÖÂ†±
                        const info = await NFTHelper.getContractInfo(this.contractAddress);
                        this.contractInfo = info;

                        if (info.totalSupply === 0) {
                            this.showStatus('„Åì„ÅÆ„Ç≥„É≥„Éà„É©„ÇØ„Éà„Å´„ÅØ„Éà„Éº„ÇØ„É≥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'info');
                            this.loading = false;
                            return;
                        }

                        // „Éà„Éº„ÇØ„É≥IDÂàóÊåô
                        this.loadingMessage = `„Éà„Éº„ÇØ„É≥‰∏ÄË¶ß„ÇíÂèñÂæó‰∏≠... (0/${info.totalSupply})`;
                        const contract = NFTHelper.getContract(this.contractAddress);
                        const batchSize = 20;
                        const tokenIds = [];

                        for (let i = 0; i < info.totalSupply; i += batchSize) {
                            const batch = [];
                            for (let j = i; j < Math.min(i + batchSize, info.totalSupply); j++) {
                                batch.push(contract.methods.tokenByIndex(j).call());
                            }
                            const results = await Promise.allSettled(batch);
                            results.forEach(r => {
                                if (r.status === 'fulfilled') tokenIds.push(r.value.toString());
                            });
                            this.loadingMessage = `„Éà„Éº„ÇØ„É≥‰∏ÄË¶ß„ÇíÂèñÂæó‰∏≠... (${Math.min(i + batchSize, info.totalSupply)}/${info.totalSupply})`;
                        }

                        // „Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº„Ç´„Éº„Éâ„ÇíÂÖà„Å´Ë°®Á§∫
                        this.tokenCards = tokenIds.map(id => ({
                            tokenId: id,
                            name: null,
                            image: null,
                        }));

                        this.showStatus(`${tokenIds.length}‰ª∂„ÅÆ„Éà„Éº„ÇØ„É≥„ÇíÂèñÂæó„Åó„Åæ„Åó„Åü„ÄÇ„É°„Çø„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...`, 'info');
                        this.loading = false;

                        // „É°„Çø„Éá„Éº„Çø„ÇíÈùûÂêåÊúü„ÅßÂèñÂæóÔºà„Ç´„Éº„Éâ„ÇíÈ†ÜÊ¨°Êõ¥Êñ∞„ÄÅ„É¨„Éº„ÉàÂà∂ÈôêÂØæÁ≠ñÔºâ
                        const metaBatchSize = 3;
                        const delay = ms => new Promise(r => setTimeout(r, ms));
                        for (let i = 0; i < tokenIds.length; i += metaBatchSize) {
                            const batch = tokenIds.slice(i, i + metaBatchSize).map(async (id, idx) => {
                                const metadata = await NFTHelper.getTokenMetadata(this.contractAddress, id);
                                if (metadata) {
                                    const cardIdx = i + idx;
                                    this.tokenCards[cardIdx] = {
                                        tokenId: id,
                                        name: metadata.name,
                                        image: metadata.image,
                                    };
                                }
                            });
                            await Promise.allSettled(batch);
                            await delay(1500);
                        }

                        this.showStatus(`${tokenIds.length}‰ª∂„ÅÆ„Éà„Éº„ÇØ„É≥„ÇíË°®Á§∫‰∏≠`, 'success');
                    } catch (error) {
                        console.error('Error:', error);
                        this.showStatus(`„Ç®„É©„Éº: ${error.message}`, 'error');
                        this.loading = false;
                    }
                },

                clearData() {
                    this.contractAddress = '';
                    this.tokenCards = [];
                    this.contractInfo = {};
                    this.statusMessage = '';
                },

                handleImageError(event) {
                    event.target.style.display = 'none';
                    // Show placeholder instead
                    const placeholder = document.createElement('div');
                    placeholder.className = 'token-card-placeholder';
                    placeholder.textContent = 'üè∫';
                    event.target.parentNode.insertBefore(placeholder, event.target);
                },

                showStatus(message, type) {
                    this.statusMessage = message;
                    this.statusClass = `status-${type}`;
                    if (type === 'success') {
                        setTimeout(() => { if (this.statusMessage === message) this.statusMessage = ''; }, 5000);
                    }
                },

                handleEscape(e) { if (e.key === 'Escape' && this.menuOpen) this.closeMenu(); },
                toggleMenu() { this.menuOpen = !this.menuOpen; document.body.style.overflow = this.menuOpen ? 'hidden' : ''; },
                closeMenu() { this.menuOpen = false; document.body.style.overflow = ''; },
            }
        }).mount('#app');
    </script>
</body>
</html>
